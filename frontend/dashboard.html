<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Sniper Bot Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Exo 2', sans-serif; 
            background-color: #0c0a15;
            background-image: 
                radial-gradient(circle at top right, rgba(121, 68, 207, 0.15), transparent 40%),
                radial-gradient(circle at bottom left, rgba(46, 161, 241, 0.15), transparent 50%);
        }
        .hex-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: -1;
        }
        .hex-bg::before {
            content: ""; position: absolute; width: 200%; height: 200%;
            top: -50%; left: -50%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="115.47" viewBox="0 0 100 115.47"><path fill="rgba(255,255,255,0.02)" d="M50 0L100 28.87v57.74L50 115.47 0 86.61V28.87L50 0z M50 5.77L6.7 31.75v51.97L50 109.7l43.3-25.98V31.75L50 5.77z"/></svg>');
            animation: pan 60s linear infinite;
        }
        @keyframes pan {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-50%, -50%); }
        }
        .card-glass {
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            background-color: rgba(12, 10, 21, 0.56);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        .card-glow {
            box-shadow: 0 0 10px -2px var(--glow-color, transparent); 
            border: 1px solid var(--border-color, rgba(255, 255, 255, 0.1));
            transition: box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }
        .card-glow:hover {
             box-shadow: 0 0 20px 0px var(--glow-color, rgba(107, 114, 128, 0.2));
             border-color: var(--border-color-hover, rgba(255, 255, 255, 0.2));
        }
        .fade-in { animation: fadeIn 0.5s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .toast {
            transform: translateY(120%);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 0;
        }
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="hex-bg"></div>
    <div class="container mx-auto p-4 md:p-8">
        <header class="flex flex-col md:flex-row justify-between md:items-center mb-6">
            <div class="flex items-center gap-3">
                <i data-lucide="crosshair" class="text-sky-400 w-8 h-8"></i>
                <h1 class="text-3xl font-bold text-white">Pro Sniper Dashboard</h1>
            </div>
            <div class="text-left md:text-right mt-4 md:mt-0">
                <p class="text-sm text-gray-400 flex items-center gap-2 justify-start md:justify-end">
                    <span id="status-indicator" class="w-3 h-3 rounded-full bg-green-400 animate-pulse"></span>
                    <span id="status-text">Live</span>
                </p>
                <p class="text-sm text-gray-400">Last Update: <span id="last-updated" class="font-mono">...</span></p>
            </div>
        </header>

        <div class="mb-8 card-glass p-4 rounded-lg flex flex-col lg:flex-row items-center gap-4">
            <div class="w-full lg:flex-grow flex items-center gap-4">
                <i data-lucide="search" class="text-gray-400 flex-shrink-0"></i>
                <input type="text" id="search-bar" placeholder="Search by name, mint ID, or grading ID..." class="w-full bg-transparent text-white placeholder-gray-500 focus:outline-none">
            </div>

            <div class="w-full lg:w-auto border-t lg:border-t-0 lg:border-l border-gray-700 my-4 lg:my-0 lg:mx-4 lg:h-8"></div>
            
            <div class="w-full lg:w-auto flex flex-col sm:flex-row items-center gap-4">
                <div class="w-full sm:w-auto flex items-center gap-2">
                    <label for="filter-by" class="text-gray-400 text-sm flex-shrink-0">Filter:</label>
                    <select id="filter-by" class="custom-select bg-gray-900/50 border border-gray-700 text-white text-sm rounded-md focus:ring-sky-500 focus:border-sky-500 block w-full p-2">
                        <option value="ALL">Show All</option>
                        <option value="AUTOBUY">Autobuy (Gold)</option>
                        <option value="GOOD">Alert (Red)</option>
                        <option value="OK">Info (Blue)</option>
                    </select>
                </div>
                <div class="w-full sm:w-auto flex items-center gap-2">
                    <label for="sort-by" class="text-gray-400 text-sm flex-shrink-0">Sort:</label>
                    <select id="sort-by" class="custom-select bg-gray-900/50 border border-gray-700 text-white text-sm rounded-md focus:ring-sky-500 focus:border-sky-500 block w-full p-2">
                        <option value="listed_at">Listed Time</option>
                        <option value="price_amount">Price</option>
                        <option value="diffPercent">Difference %</option>
                        <option value="avg_price">Cartel AVG</option>
                    </select>
                    <button id="sort-direction" class="p-2 bg-gray-900/50 border border-gray-700 rounded-md text-gray-400 hover:text-white hover:border-sky-500 flex-shrink-0">
                        <i data-lucide="arrow-down-wide-narrow" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </div>

        <main>
            <div id="loading" class="text-center p-12">
                <i data-lucide="loader-2" class="mx-auto h-12 w-12 text-sky-400 animate-spin"></i>
                <p class="text-lg mt-4 text-gray-400">Connecting to live API...</p>
            </div>

            <div id="error" class="hidden card-glass p-4 rounded-lg border-red-500/50" role="alert">
                 <div class="flex items-center">
                    <i data-lucide="alert-triangle" class="mr-3 text-red-400"></i>
                    <div>
                        <strong class="font-bold text-red-300">API Connection Error!</strong>
                        <span class="block sm:inline text-red-400" id="error-message">Could not connect.</span>
                    </div>
                </div>
            </div>
            
            <div id="listings-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
            </div>
        </main>
    </div>

    <div id="toast" class="toast fixed bottom-5 right-5 card-glass rounded-lg shadow-lg p-4 flex items-center gap-3 border-green-400/30 z-50">
        <i id="toast-icon" data-lucide="check-circle" class="text-green-400"></i>
        <span id="toast-message" class="text-white"></span>
    </div>

    <script>
        // --- CONFIGURATION: UPDATE THESE VALUES ---
        const API_URL = 'http://48.211.165.95:5000/api/listings';
        const API_KEY = 'd89a03e8-3263-46c9-92d3-ed7874b58458';
        // ------------------------------------------

        let solPriceUSD = 150;
        let allListingsCache = [];
        let currentSort = { key: 'listed_at', direction: 'desc' };
        let currentFilter = 'ALL';

        const listingsGrid = document.getElementById('listings-grid');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const lastUpdatedSpan = document.getElementById('last-updated');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const errorMessageSpan = document.getElementById('error-message');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const toastIcon = document.getElementById('toast-icon');
        const searchBar = document.getElementById('search-bar');
        const sortBySelect = document.getElementById('sort-by');
        const sortDirectionBtn = document.getElementById('sort-direction');
        const filterBySelect = document.getElementById('filter-by');

        function getCategoryStyle(category) {
            const styles = {
                'AUTOBUY': { badge: 'bg-yellow-400/10 text-yellow-300 border-yellow-400/20', glow: 'rgba(250, 204, 21, 0.5)', border: 'rgba(250, 204, 21, 0.3)', hover: 'rgba(250, 204, 21, 0.4)' },
                'GOOD':    { badge: 'bg-red-500/10 text-red-400 border-red-500/20',       glow: 'rgba(239, 68, 68, 0.4)', border: 'rgba(239, 68, 68, 0.25)', hover: 'rgba(239, 68, 68, 0.35)' },
                'OK':      { badge: 'bg-sky-500/10 text-sky-300 border-sky-500/20',        glow: 'rgba(56, 189, 248, 0.4)', border: 'rgba(56, 189, 248, 0.25)', hover: 'rgba(56, 189, 248, 0.35)' },
            };
            const fallback = { badge: 'hidden', glow: 'transparent', border: 'rgba(255, 255, 255, 0.1)', hover: 'rgba(255, 255, 255, 0.2)'};
            return styles[category] || fallback;
        }
        
        function timeAgo(dateString) { 
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return "Just now";
            const intervals = { year: 31536000, month: 2592000, day: 86400, hour: 3600, minute: 60 };
            if (seconds < intervals.hour) return Math.floor(seconds / intervals.minute) + " mins ago";
            if (seconds < intervals.day) return Math.floor(seconds / intervals.hour) + " hours ago";
            if (seconds < intervals.month) return Math.floor(seconds / intervals.day) + " days ago";
            if (seconds < intervals.year) return Math.floor(seconds / intervals.month) + " months ago";
            return Math.floor(seconds / intervals.year) + " years ago";
        }

        function getAltConfidenceColor(confidence) {
            if (confidence === null || confidence === undefined) return 'text-gray-400';
            if (confidence > 75) return 'text-yellow-300';
            if (confidence > 40) return 'text-orange-400';
            return 'text-red-500';
        }

        function getDifferenceColor(category) {
            const colorMap = {
                'AUTOBUY': 'text-yellow-300 font-bold',
                'GOOD': 'text-red-400',
                'OK': 'text-sky-300',
            };
            return colorMap[category] || 'text-gray-400';
        }

        async function fetchSolPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana&vs_currencies=usd');
                if (!response.ok) return;
                const data = await response.json();
                if (data.solana && data.solana.usd) solPriceUSD = data.solana.usd;
            } catch (error) {
                console.warn('Could not fetch SOL price, using fallback value.', error);
            }
        }

        function renderListings(listings) {
            loadingDiv.style.display = 'none';
            if (listings.length === 0) {
                listingsGrid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-400 card-glass rounded-lg">No listings found matching criteria. The bot is actively scanning...</div>';
                return;
            }

            const cardElements = listings.map(listing => {
                const listingPriceUSD = listing.price_amount ? listing.price_amount * solPriceUSD : null;
                const diffPercent = listing.diffPercent;
                const categoryStyle = getCategoryStyle(listing.cartel_category);
                const altConfidenceColor = getAltConfidenceColor(listing.alt_value_confidence);
                const differenceColor = getDifferenceColor(listing.cartel_category);
                
                const cardElement = document.createElement('div');
                cardElement.className = 'card-glass card-glow rounded-xl shadow-lg flex flex-col transition-all duration-300';
                cardElement.style.setProperty('--glow-color', categoryStyle.glow);
                cardElement.style.setProperty('--border-color', categoryStyle.border);
                cardElement.style.setProperty('--border-color-hover', categoryStyle.hover);
                
                cardElement.innerHTML = `
                    <div class="relative">
                        <img src="${listing.img_url || 'https://placehold.co/300x420/0c0a15/2d3748?text=N/A'}" alt="${listing.name}" class="h-72 w-full object-contain rounded-t-xl pt-4 bg-black/20">
                    </div>
                    
                    <div class="p-4 flex flex-col flex-grow">
                        <h3 class="font-bold text-white text-base leading-tight truncate mb-1" title="${listing.name}">${listing.name}</h3>
                        
                        <div class="flex justify-between items-center text-xs text-gray-400 mb-3">
                            <span>${listing.grade || 'N/A'}</span>
                            <span class="font-mono">Pop: ${listing.supply !== null ? listing.supply : 'N/A'}</span>
                        </div>
                        
                        <div class="text-xs text-gray-500 space-y-1 mb-3">
                            <p>Grading ID: <span class="font-mono text-gray-300">${listing.grading_id || 'N/A'}</span></p>
                            <p>Insured: <span class="font-mono text-gray-300">${listing.insured_value !== null ? '$'+listing.insured_value.toFixed(2) : 'N/A'}</span></p>
                        </div>

                        <div class="grid grid-cols-2 gap-2 my-2">
                            <div class="bg-black/20 p-2 rounded-md border border-gray-700/50 text-center">
                                <p class="text-xs text-gray-400 flex items-center justify-center gap-1"><i data-lucide="wallet-cards" class="w-3 h-3"></i>Price (SOL)</p>
                                <p class="font-mono text-white text-lg">${listing.price_amount ? listing.price_amount.toFixed(4) : 'N/A'}</p>
                                <p class="font-mono text-xs text-gray-500">${listingPriceUSD ? '~$' + listingPriceUSD.toFixed(2) : ''}</p>
                            </div>
                            <div class="bg-black/20 p-2 rounded-md border border-gray-700/50 text-center">
                                <p class="text-xs text-gray-400 flex items-center justify-center gap-1"><i data-lucide="trending-down" class="w-3 h-3"></i>Difference</p>
                                <p class="font-mono text-lg font-semibold ${differenceColor}">${diffPercent !== null ? diffPercent.toFixed(2) + '%' : 'N/A'}</p>
                                <p class="font-mono text-xs text-gray-500">&nbsp;</p>
                            </div>
                            <div class="bg-black/20 p-2 rounded-md border border-gray-700/50 text-center">
                                <p class="text-xs text-gray-400 flex items-center justify-center gap-1"><i data-lucide="tag" class="w-3 h-3"></i>ALT Value</p>
                                <p class="font-mono text-lg ${altConfidenceColor}">${listing.alt_value !== null ? '$'+listing.alt_value.toFixed(2) : 'N/A'}</p>
                                <p class="font-mono text-xs text-gray-500">${(listing.alt_value_lower_bound !== null && listing.alt_value_upper_bound !== null) ? '$'+listing.alt_value_lower_bound.toFixed(2)+' - $'+listing.alt_value_upper_bound.toFixed(2) : 'N/A'}</p>
                            </div>
                            <div class="bg-black/20 p-2 rounded-md border border-gray-700/50 text-center">
                                <p class="text-xs text-gray-400 flex items-center justify-center gap-1"><i data-lucide="bar-chart-4" class="w-3 h-3"></i>Cartel AVG</p>
                                <p class="font-mono text-lg text-white">${listing.avg_price !== null ? '$'+listing.avg_price.toFixed(2) : 'N/A'}</p>
                                 <p class="font-mono text-xs text-gray-500">&nbsp;</p>
                            </div>
                        </div>
                        
                        <div class="flex-grow"></div>
                        
                        <div class="mt-4 pt-4 border-t border-gray-700/50 space-y-2">
                             <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                     <a href="${listing.alt_asset_id ? `https://app.alt.xyz/research/${listing.alt_asset_id}` : '#'}" target="_blank" title="View on ALT.xyz" class="text-gray-500 hover:opacity-80 transition-opacity"><img src="https://cdn.prod.website-files.com/62829b28e6300b34ff739f02/629661dd02bdba04fb424173_ALT-white-logo.png" class="w-5 h-5 object-contain" alt="ALT logo"></a>
                                     <a href="https://collectorcrypt.com/assets/solana/${listing.token_mint}" target="_blank" title="View on Collector Crypt" class="text-gray-500 hover:opacity-80 transition-opacity"><img src="https://www.marketbeat.com/logos/cryptocurrencies/collector-crypt-CARDS.png?v=2025-09-12" class="w-5 h-5 object-contain bg-white rounded-full p-0.5" alt="CC logo"></a>
                                     <button data-mint="${listing.token_mint}" class="copy-btn text-gray-500 hover:text-sky-400 transition-colors"><i data-lucide="copy" class="w-4 h-4"></i></button>
                                </div>
                                <p class="text-xs text-gray-500">${timeAgo(listing.listed_at)}</p>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button data-listing-id="${listing.listing_id}" class="buy-now-btn flex-1 flex items-center justify-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-black text-sm font-bold py-2 px-3 rounded-md transition-colors duration-200">
                                    <i data-lucide="zap" class="w-4 h-4"></i>
                                    <span>Buy Now</span>
                                </button>
                                <a href="https://magiceden.io/item-details/${listing.token_mint}" target="_blank" class="flex-1 flex items-center justify-center gap-2 text-center bg-sky-500/20 hover:bg-sky-500/40 text-sky-300 text-sm font-bold py-2 px-3 rounded-md transition-colors duration-200">
                                    <img src="https://cdn.prod.website-files.com/614c99cf4f23700c8aa3752a/637db1043720a3ea88e4ea96_public.png" class="w-5 h-5 object-contain" alt="Magic Eden Logo">
                                    <span>View on ME</span>
                                </a>
                            </div>
                        </div>
                    `;
                return cardElement;
            });
            listingsGrid.replaceChildren(...cardElements);
            lucide.createIcons();
        }
        
        function updateDisplay() {
            let processedListings = allListingsCache.map(l => {
                const listingPriceUSD = l.price_amount ? l.price_amount * solPriceUSD : null;
                const diffPercent = (listingPriceUSD && l.alt_value > 0) ? (((listingPriceUSD - l.alt_value) / l.alt_value) * 100) : null;
                return { ...l, diffPercent };
            });

            if (currentFilter !== 'ALL') {
                processedListings = processedListings.filter(l => l.cartel_category === currentFilter);
            }

            processedListings.sort((a, b) => {
                let valA = a[currentSort.key];
                let valB = b[currentSort.key];
                if (currentSort.key === 'listed_at' && valA && valB) {
                    valA = new Date(valA).getTime();
                    valB = new Date(valB).getTime();
                }
                if (valA === null || valA === undefined) return 1;
                if (valB === null || valB === undefined) return -1;
                const order = (valA < valB) ? -1 : (valA > valB) ? 1 : 0;
                return currentSort.direction === 'asc' ? order : -order;
            });

            const searchTerm = searchBar.value.toLowerCase();
            if (searchTerm) {
                processedListings = processedListings.filter(l => 
                    l.name.toLowerCase().includes(searchTerm) ||
                    l.token_mint.toLowerCase().includes(searchTerm) ||
                    l.grading_id.toLowerCase().includes(searchTerm)
                );
            }
            
            renderListings(processedListings);
        }

        async function fetchListingsAndRender() {
            try {
                // MODIFIED: Added headers object to fetch call
                const response = await fetch(API_URL, {
                    headers: {
                        'X-API-Key': API_KEY
                    }
                });
                if (!response.ok) {
                    if (response.status === 401) {
                         throw new Error(`Unauthorized: Invalid API Key.`);
                    }
                    throw new Error(`API returned status ${response.status}`);
                }
                allListingsCache = await response.json();
                updateDisplay();
                
                lastUpdatedSpan.textContent = new Date().toLocaleTimeString();
                statusIndicator.className = 'w-3 h-3 rounded-full bg-green-400 animate-pulse';
                statusText.textContent = 'Live';
                errorDiv.classList.add('hidden');
            } catch(e) { 
                console.error('Failed to fetch listings:', e);
                statusIndicator.className = 'w-3 h-3 rounded-full bg-red-500';
                statusText.textContent = 'Error';
                errorDiv.classList.remove('hidden');
                errorMessageSpan.textContent = e.message || `Could not connect to the API. Last attempt failed at ${new Date().toLocaleTimeString()}.`;
            } finally {
                lastUpdatedSpan.textContent = new Date().toLocaleTimeString();
            }
        }

        searchBar.addEventListener('input', updateDisplay);
        sortBySelect.addEventListener('change', (e) => {
            currentSort.key = e.target.value;
            updateDisplay();
        });
        sortDirectionBtn.addEventListener('click', () => {
            currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            sortDirectionBtn.innerHTML = currentSort.direction === 'asc' ? 
                '<i data-lucide="arrow-up-wide-narrow" class="w-5 h-5"></i>' : 
                '<i data-lucide="arrow-down-wide-narrow" class="w-5 h-5"></i>';
            lucide.createIcons();
            updateDisplay();
        });
        filterBySelect.addEventListener('change', (e) => {
            currentFilter = e.target.value;
            updateDisplay();
        });

        function showToast(message, isSuccess = true) {
            toastMessage.textContent = message;
            toastIcon.innerHTML = isSuccess ? '<i data-lucide="check-circle" class="text-green-400"></i>' : '<i data-lucide="zap" class="text-yellow-300"></i>';
            lucide.createIcons();
            toast.className = `toast fixed bottom-5 right-5 card-glass rounded-lg shadow-lg p-4 flex items-center gap-3 z-50 ${isSuccess ? 'border-green-400/30' : 'border-yellow-400/30'} show`;
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        document.addEventListener('click', function(event) {
            const buyNowBtn = event.target.closest('.buy-now-btn');
            if (buyNowBtn) {
                const listingId = buyNowBtn.dataset.listingId;
                console.log(`Buy Now triggered for listing ID: ${listingId}`);
                showToast(`"Buy Now" logic for ${listingId.substring(0, 8)}... would run.`, false);
            }

            const copyBtn = event.target.closest('.copy-btn');
            if (copyBtn) {
                const mint = copyBtn.dataset.mint;
                const textArea = document.createElement("textarea");
                textArea.value = mint;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showToast('Mint ID copied to clipboard!');
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                }
                document.body.removeChild(textArea);
            }
        });
        
        async function initialize() {
            lucide.createIcons();
            await fetchSolPrice();
            await fetchListingsAndRender();
            setInterval(fetchListingsAndRender, 5000);
            setInterval(fetchSolPrice, 60000);
        }

        initialize();
    </script>
</body>
</html>

